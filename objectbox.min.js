// Objectbox.js - https://github.com/thunder9/objectbox.js
(function(e){var t,r=e._||require("underscore");t="undefined"!=typeof exports?exports:e.objectbox={};var n={_caches:{},get:function(e){var t=e.getId();return r.has(this._caches,t)?this._caches[t]:this._caches[t]=e.getFields()},deleteCache:function(e){var t=e.getId();r.has(this._caches,t)&&delete this._caches[t]},clear:function(){this._caches={}}},c=function(e,t){var r={};return r.table=e,r.fields={},r.depth=0,f(l,C,r,t)},o=function(e,t){var r={};return r.table=e.getTable(),r.record=e,r.fields={},r.depth=0,f(h,R,r,t)},i=function(e,t,r){var n={};return n[t]=r,o(e,n)},d=function(e){var t={};return t.table=e.getTable(),t.record=e,t.fields={},f(v,_,t,n.get(e))},u=function(e){var t={};return t.table=e.getTable(),t.record=e,t.fields={},f(b,x,t,n.get(e))},a=function(e,t){var r=d(e);return t?r[t]:r},s=function(e,t,n){return r.isNumber(n)&&(t.depth=n),e.query(t)},f=function(e,t,n,c){return w(c)?t(r.reduce(c,e,n)):c},l=function(e,t,n){if(w(t)){var c=O(e);c.depth=e.depth+1,t=f(l,q,c,t)}return r.isArray(t)&&(t=r.map(t,function(t){if(w(t)){var r=O(e);r.depth=e.depth+1,t=f(l,q,r,t)}return t})),e.fields[n]=t,e},h=function(e,t,c){var o=n.get(e.record),i=o[c];if(D(i)){var d=e.table.get(G(i));if(w(t)){var a=O(e);return a.record=d,a.depth=e.depth+1,e.fields[c]=f(h,F,a,t),e}u(d)}return I(i)&&r.each(i.toArray(),function(t){if(D(t)){var r=e.table.get(G(t));u(r)}}),l(e,t,c)},p=function(e,t,c,o,i){if(c.fields[i]=o,D(o)){var d=O(c);d.record=c.table.get(G(o));var u=d.record?n.get(d.record):null;c.fields[i]=f(g[e],g[t],d,u)}return I(o)&&(c.fields[i]=r.map(o.toArray(),function(r){if(D(r)){var o=O(c);o.record=c.table.get(G(r));var i=o.record?n.get(o.record):null;r=f(g[e],g[t],o,i)}return r})),c},g={},v=g.getter=r.partial(p,"getter","postGet"),b=g.deleter=r.partial(p,"deleter","postDelete"),y=function(e){return e.fields.depth=e.depth,e.record=e.table.insert(e.fields),e},m=function(e){return n.deleteCache(e.record),e.record=e.record.update(e.fields),e},_=g.postGet=function(e){return r.has(e.fields,"depth")&&delete e.fields.depth,e.fields},x=g.postDelete=function(e){return n.deleteCache(e.record),e.record.deleteRecord()},A=function(e){return"id:"+e.record.getId()},j=function(e){return e.record},q=r.compose(A,y),C=r.compose(j,y),F=r.compose(A,m),R=r.compose(j,m),T=Object.prototype.toString,w=function(e){return e&&"[object Object]"===T.call(e)},I=function(e){return e&&r.isFunction(e.toArray)},D=function(e){return r.isString(e)&&"id:"===e.substring(0,3)},G=function(e){return e.slice(3)},O=function(e){return cloned=r.clone(e),cloned.fields={},cloned},S=function(e){return this instanceof S?(this.table=e,void 0):new S(e)},N=function(e){return this instanceof N?(this.record=e,void 0):new N(e)};t.insert=c,t.query=s,t.get=a,t.set=i,t.update=o,t.deleteRecord=u,t.getFields=d,t.clearChache=n.clear,t.Table=S,t.Record=N;var k=function(e,n,c){var o={};return r.each(n,function(n){o[n]=function(){return c(t[n].apply(this,[this[e]].concat(r.toArray(arguments))))}}),o},z=function(e){return r.isArray(e)?r.map(e,function(e){return z(e)}):new N(e)};r.extend(S.prototype,k("table",["insert","query"],z)),r.extend(N.prototype,k("record",["set","update","deleteRecord"],z)),r.extend(N.prototype,k("record",["get","getFields"],r.identity))})(this);